---
title: "Dam Decommissioning & Invertebrate Recovery: A BACI Analysis Tutorial"
subtitle: "Replicating the treatment effect from Atristain et al. (2024)"
author: "Your Names Here"
date: "2026-03-20"
format:
  html:
    code-fold: show
    toc: true
    theme: cosmo
---

```{r}
#| label: setup
#| message: false
#| warning: false

library(tidyverse)
library(readxl)
library(lme4)
library(broom.mixed)
library(knitr)
```

## Study Overview

Atristain et al. (2024) investigated whether decommissioning a large dam (42 m tall, Enobieta Dam, northern Spain) restored downstream macroinvertebrate communities. They used a **multiple Before-After/Control-Impact (mBACI) design** — which is the ecological equivalent of a **difference-in-differences (DiD)** framework.

**The causal question:** Did the reservoir drawdown cause invertebrate communities at impact sites to recover to levels comparable to undammed control sites?

**The treatment:** Reservoir drawdown (initiated December 2018, completed November 2019).

**Primary finding we'll replicate:** The effect of drawdown on *taxa richness* (S), measured by the period × reach interaction in a linear mixed-effects model.

## The mBACI Design as Difference-in-Differences

The mBACI design maps directly onto the DiD framework you've seen in class:

| DiD Term | mBACI Equivalent | Description |
|----------|-----------------|-------------|
| Treatment group | Impact sites (I1–I4) | Sites downstream of the dam |
| Control group | Control sites (C1–C4) | Undammed tributaries & upstream site |
| Pre-treatment | Before period (B) | November 2017 |
| Post-treatment | Drawdown (D) & After (A) | October 2019 & November 2020 |
| Treatment effect | Period × Reach interaction | DiD estimator |

The key assumption — **parallel trends** — requires that control and impact sites would have followed the same trajectory in the absence of the drawdown. The use of *multiple* control sites in different tributaries strengthens this assumption.

## Step 1: Load and Wrangle the Data

```{r}
#| label: load-data

# read the invertebrates sheet from the Dryad dataset
invert_raw <- read_excel("Atristainetal_JAE_Data.xlsx",
                         sheet = "Invertebrates")

# the sheet has two columns named "Site" — rename for clarity
# col 1 = site name (e.g., "Enobieta Up"), col 5 = site code (e.g., "C1")
colnames(invert_raw)[1] <- "site_name"
colnames(invert_raw)[5] <- "site_code"
```

```{r}
#| label: wrangle

invert <- invert_raw |>
  # select only the columns we need for the BACI analysis
  select(site_name, Replicate, Period, Reach, site_code, S, `H´`, TD, IASPT) |>
  rename(
    richness = S,
    shannon = `H´`,
    density = TD
  ) |>
  # create a binary reach type variable: control (C) vs impact (I)
  # this collapses I1-I4 into one "impact" group for the DiD
  mutate(
    reach_type = case_when(
      Reach == "C" ~ "C",
      Reach == "R" ~ "R",
      TRUE ~ "I"
    ),
    # set factor levels so "before" and "control" are the reference
    period = factor(Period, levels = c("B", "D", "A"),
                    labels = c("Before", "Drawdown", "After")),
    reach_type = factor(reach_type, levels = c("C", "I", "R"))
  )

glimpse(invert)
```

For the main mBACI model, we exclude the reservoir sites (R) — they were only sampled in the "After" period, so they can't be part of the before-after comparison.

```{r}
#| label: filter-baci

# filter to just control and impact sites for the BACI analysis
invert_baci <- invert |>
  filter(reach_type %in% c("C", "I"))
```

**Sample sizes:** `r nrow(filter(invert_baci, period == "Before"))` samples before, `r nrow(filter(invert_baci, period == "Drawdown"))` during drawdown, and `r nrow(filter(invert_baci, period == "After"))` after — split evenly between control and impact sites (5 Surber net replicates × 4 sites per group × 3 periods = 120 total).

## Step 2: Explore the Data

Before modeling, let's see what the data look like. This replicates the pattern shown in Figure 3 of the paper.

```{r}
#| label: fig-richness
#| fig-cap: "Taxa richness across periods and reach types. Before drawdown, impact sites had notably lower richness than controls — especially I1 (closest to the dam). After drawdown, impact sites recovered to match controls."
#| fig-width: 9
#| fig-height: 5

invert_baci |>
  ggplot(aes(x = site_code, y = richness, fill = reach_type)) +
  geom_boxplot(alpha = 0.7, outlier.size = 1) +
  facet_wrap(~period, ncol = 3) +
  scale_fill_manual(
    values = c("C" = "#4393C3", "I" = "#D6604D"),
    labels = c("Control", "Impact")
  ) +
  labs(
    x = "Site",
    y = "Taxa richness (S)",
    fill = "Reach type"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

The visual pattern tells the story: before drawdown, impact sites (especially I1 and I2, closest to the dam) had substantially fewer taxa. By the "After" period, they look indistinguishable from controls. That convergence is the treatment effect we want to estimate formally.

Let's also compute group means to see the DiD structure:

```{r}
#| label: did-table

did_means <- invert_baci |>
  group_by(period, reach_type) |>
  summarise(
    mean_richness = mean(richness),
    se = sd(richness) / sqrt(n()),
    .groups = "drop"
  )

did_means |>
  kable(digits = 1, col.names = c("Period", "Reach", "Mean S", "SE"))
```

```{r}
#| label: fig-did
#| fig-cap: "Mean taxa richness by period and reach type — the classic DiD visualization. The gap between control and impact narrows over time, indicating recovery."
#| fig-width: 7
#| fig-height: 4.5

did_means |>
  ggplot(aes(x = period, y = mean_richness,
             color = reach_type, group = reach_type)) +
  geom_point(size = 3) +
  geom_line(linewidth = 1) +
  geom_errorbar(aes(ymin = mean_richness - 1.96 * se,
                    ymax = mean_richness + 1.96 * se),
                width = 0.1) +
  scale_color_manual(
    values = c("C" = "#4393C3", "I" = "#D6604D"),
    labels = c("Control", "Impact")
  ) +
  labs(
    x = "Period",
    y = "Mean taxa richness (S)",
    color = "Reach type"
  ) +
  theme_minimal(base_size = 13)
```

This is the visual signature of a successful restoration: the impact group converges toward the control group over time. In a standard DiD, this convergence is the treatment effect.

## Step 3: Fit the mBACI Model

The paper uses a linear mixed-effects (LME) model with:

- **Fixed effects:** `period`, `reach_type`, and their interaction (`period:reach_type`)
- **Random effect:** `site_code` (to account for repeated measures at the same site across replicates)

The interaction term `period:reach_type` is the **DiD estimator** — it captures whether the *change over time* differed between control and impact sites.

```{r}
#| label: fit-model

# fit the mBACI linear mixed-effects model
# this is the exact specification from the paper (Section 2.5)
mod_richness <- lmer(richness ~ period * reach_type + (1 | site_code),
                     data = invert_baci,
                     REML = TRUE)

summary(mod_richness)
```

## Step 4: Interpret the Coefficients

Let's extract the fixed effects and interpret them in the DiD framework:

```{r}
#| label: tidy-model

tidy(mod_richness, effects = "fixed", conf.int = TRUE) |>
  kable(digits = 3,
        col.names = c("Term", "Estimate", "SE", "Statistic",
                       "df", "p-value", "CI Lower", "CI Upper"))
```

Here's how to read each coefficient:

| Coefficient | Interpretation |
|-------------|---------------|
| `(Intercept)` | Mean richness for control sites in the Before period |
| `reach_typeI` | Baseline difference: impact minus control in the Before period (**BCI** in the paper) |
| `periodDrawdown` | Change in control sites from Before to Drawdown |
| `periodAfter` | Change in control sites from Before to After |
| `periodDrawdown:reach_typeI` | **DiD estimator (BD:CI)**: Did impact sites change *differently* than controls from Before → Drawdown? |
| `periodAfter:reach_typeI` | **DiD estimator (BA:CI)**: Did impact sites change *differently* than controls from Before → After? |

The two interaction terms are the key treatment effects. A positive `periodAfter:reach_typeI` means impact sites gained more richness than controls between the Before and After periods — i.e., they recovered.

## Step 5: Test the Overall Interaction (BDA:CI)

The paper also reports a global test of whether the interaction matters at all (Type III test of the `period:reach_type` interaction). We can get this with `anova()`:

```{r}
#| label: anova

# test the overall period x reach_type interaction
# this corresponds to the BDA:CI test in the paper
anova(mod_richness)
```

The significant interaction (`period:reach_type`) tells us that the trajectory of taxa richness over time *depended on* whether a site was downstream of the dam or not. In other words, the drawdown had a causal effect on invertebrate richness at impact sites.

## Step 6: Effect Sizes

To match the paper's approach, we can compute log-ratio effect sizes for each impact site relative to the control mean. This shows how the dam's effect decreased with distance downstream.

```{r}
#| label: effect-sizes

effect_sizes <- invert_baci |>
  group_by(period, site_code, reach_type) |>
  summarise(mean_richness = mean(richness), .groups = "drop") |>
  # get the control mean for each period
  group_by(period) |>
  mutate(control_mean = mean(mean_richness[reach_type == "C"])) |>
  ungroup() |>
  # compute ln-ratio for impact sites only
  filter(reach_type == "I") |>
  mutate(effect_size = log(mean_richness / control_mean))

effect_sizes |>
  select(period, site_code, mean_richness, control_mean, effect_size) |>
  kable(digits = 2,
        col.names = c("Period", "Site", "Mean S", "Control Mean", "Ln-ratio"))
```

Negative values mean the impact site had lower richness than controls. In the Before period, I1 (closest to the dam) had the largest negative effect. By the After period, effect sizes are near zero — recovery.

## Key Assumptions and Evaluation

The mBACI/DiD approach rests on several assumptions:

**1. Parallel trends:** Control and impact sites would have followed the same trajectory without the drawdown. This is supported by the *multiple* control sites in independent tributaries, which reduces the risk that a single idiosyncratic control drives the result. However, with only one pre-treatment time point, we can't formally test pre-trends.

**2. No spillover (SUTVA):** The drawdown at impact sites didn't affect control sites. This is reasonable because the controls are in separate tributaries (C2–C4) or upstream of the dam (C1).

**3. No confounders coinciding with treatment timing:** Nothing else changed between periods that differentially affected impact vs. control sites. The pristine, protected status of the Artikutza catchment makes this plausible.

**One limitation:** There is only a single pre-treatment sampling point (November 2017), making it impossible to formally test parallel pre-trends — a common concern in DiD designs.

## Summary

We replicated the primary finding from Atristain et al. (2024): the reservoir drawdown caused a significant recovery in invertebrate taxa richness at impact sites. The mBACI design, which is functionally a difference-in-differences estimator with mixed effects, identified this treatment effect by comparing the *change over time* between impacted and control reaches. One year after drawdown, impact sites were indistinguishable from controls, suggesting rapid ecological recovery.

## References

Atristain, M., Solagaistua, L., Larrañaga, A., von Schiller, D., & Elosegi, A. (2024). Slow drawdown, fast recovery: Stream macroinvertebrate communities improve quickly after large dam decommissioning. *Journal of Applied Ecology*, 61, 1481–1491. https://doi.org/10.1111/1365-2664.14656

Bates, D., Mächler, M., Bolker, B., & Walker, S. (2015). Fitting linear mixed-effects models using lme4. *Journal of Statistical Software*, 67, 1–48.

Underwood, A. J. (1994). On beyond BACI: Sampling designs that might reliably detect environmental disturbances. *Ecological Applications*, 4(1), 4–15.
